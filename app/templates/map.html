<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>GPS Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html,body,#map { height:100%; margin:0; }
    .legend { position:absolute; top:10px; left:10px; background:#fff; padding:8px 10px; border-radius:6px; box-shadow:0 0 10px rgba(0,0,0,.1); }
  </style>
</head>
<body>
  <div class="legend">
    Device: <input id="dev" value="{{ default_device }}" size="12"/>
    Limit: <input id="lim" value="200" size="4"/>
    <button onclick="reloadData()">Load</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map');
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

    let layer = null;

    async function reloadData() {
      const dev = document.getElementById('dev').value;
      const lim = document.getElementById('lim').value;
      const res = await fetch(`/geojson?device_id=${encodeURIComponent(dev)}&limit=${encodeURIComponent(lim)}`);
      const gj = await res.json();

      if (layer) layer.remove();
      layer = L.geoJSON(gj).addTo(map);

      const coords = gj.features.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]]);
      if (coords.length) {
        const bounds = L.latLngBounds(coords);
        map.fitBounds(bounds.pad(0.2));
      } else {
        map.setView([23.7809, 90.2792], 12); // default view (Dhaka)
      }
    }

    reloadData();
  </script>
</body>
</html>